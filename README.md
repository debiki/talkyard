<!--
Old GitHub one-line description:
- Discussion forums with Question & Answers and Team Chat features. Plus embedded comments for your blog.

Current:
- Open source StackOverflow, Slack, Discourse, Reddit, Disqus hybrid — for your online community.

Other alternatives?:
- Community software, brings together the best from StackOverflow + Slack + Reddit + Discourse.
- Online community software. Find ideas and answers together, and pick the right things
to do, to change society, or grow your startup.
-->


Talkyard
=============================

<!-- Community discussion platform, or Structured discussion platform? A/B test?
Or "Structured discussions, for your community — Talkyard brings together ..." ? -->
A structured discussions platform — brings together the main features from
StackOverflow, Slack, Discourse, Reddit/HackerNews, and Disqus blog comments.

<!--
Create a place to talk,
where your audience find answers to their questions, and discuss ideas.<br>
Place it at `talkyard.Your-Website.org`.

 - **Solve problems** step by step, in traditional flat forum topics.
-->

 - **Save time.** People find help "instantly", in Question & Answers topics.
 - **Crowdsource feedback and ideas.** Discuss, upvote, choose the right things to do.
 - **Collaborate,** in team chats.
 - **Talk with your blog readers,** in embedded comments.

For your co-workers / customers /
students / volunteers /
contributors / users.

You can use Slack and Mattermost etc for day to day teamwork,
combined with Talkyard for the more important discussions
that you want to find in a nice-to-read format, months and years later.

Or use Talkyard for customer support, or for schools and students helping each other.

How does Talkyard compare with
StackOverflow for Teams, Discourse, Slack, Facebook Groups, Disqus?<br>
— <a href="https://www.talkyard.io/compared-with">Find out here.</a>


This Git repository is for *development*.<br>
**Installation instructions** are elsewhere: https://github.com/debiki/talkyard-prod-one.<br>
There's a hosting service: https://www.talkyard.io.

<!--
For your students / volunteers / colleagues / customers / donors /
open source users / city / community. -->


<!--
 - **Improve your API docs**, by embedding comments at the end of each docs page, to make it easy for people to ask and tell you if something is unclear.
   -->

<!-- (The staff configure the topic type just once, in a per category setting.) -->

[**Support forum here**](https://www.talkyard.io/forum/latest/support) (& live "demo"), at Talkyard<i></i>.io — and report bugs there too.

<!--
Use Talkyard for your workplace, as a self building FAQ. Or for customer support.
Or for your teachers and students, to help each other. Or your non-profit volunteers.
Or an open source project and its users.
We'd like to build a tool tha *people who change the world or their neighborhood* can use
to solve problems and pick the right things to do. That's why we have
find-solutions Question-Answers topics, and HackerNews & Reddit type topics
where good ideas rise to the top.<! - — And you can use this tool,
for your workplace and your colleagues & customers,
or your non-profit and its volunteers,
or an open source project and its users,
or a school and its students, etc.  -->

<!--
Talkyard (formerly EffectiveDiscussions) is discussion forum software, with chat and question-answers features.
And embedded comments for static websites / blogs.
Inspired by Discourse, Slack, StackOverflow, Reddit and Hacker News, Disqus. -->

You'll find **Docker image** build files in: <code>./images/<i>image-name</i>/</code>

This is beta software; there might be bugs.


<!--
### Project size

It's sort of possible for one person to understand all of Talkyard —
as May 2021, `https://github.com/boyter/scc` says
Talkyard is 140 000  (111 359 + 32 653 = 144 012) lines of code and comments
(excluding blank lines).   **and** that was with some other changes, different branch.
Plus about 60 000 (59 425) lines test code.
Server side code complexity: 5538, client side (a React.js web app): 8478.

scc modules/ed-core/src  modules/ty-dao-rdb/src/ client/app-* client/embedded-comments/  client/serviceworker/  client/*.ts  app/  s/  Makefile to-talkyard/src/  gulpfile.js images/web/ed-lua/  images/web/*.conf  images/app/Dockerfile.*  images/rdb/

scc tests/

-->


<!-- Some Features -----------
- Avoid mistakes: See if people disagree.
- Anonymous questions: So people dare to ask embarassing questions, or post crazy creative ideas.
- 
- 
-->


Screenshots
-----------

### Question-Answers:

The good answers surface to the top.

![Question and Answers](https://raw.githubusercontent.com/debiki/talkyard-media/bf78d26ec3f4da976d9c694a660d40b718d86043/for-docs/2018-08-19-question-ex.jpeg "Question-Answers")
<!--
![Question and Answers](/images/web/ty-media/for-docs/2018-08-19-question-ex.jpeg?raw=true "Question-Answers") -->

<!--
![how-work-from-home-vpn-broken-borders](https://user-images.githubusercontent.com/7477359/44306101-0041eb80-a388-11e8-92e8-b8d417c47139.jpg)
-->

### Avoid mistakes

See if others disagree with something, so you can avoid following the wrong advice.

<br>

![Avoid mistakes](https://tyw-49f8.kxcdn.com/-/u/e7ef490a72/2/m/nu/zecljq7vwtuyxqfabsjwqzg6bfmyvr.jpg)

<br>


### Recent replies — find them:

You leave for lunch, or go home over the night — and return to a Question-Answers topic the next day. Did someone post more replies, when you were away? You want to find and read?

You can directly find the most recent answers and replies: Open the sidebar, click the Recent tab, and find the most recent replies, click to scroll.

(But at StackOverflow, Reddit, HackerNews etc, it's hard to find them (since the discussions are threaded). You need to carefully scan the whole discussion from top to bottom.)

<br>
<br>

![Recent replies](https://raw.githubusercontent.com/debiki/talkyard-media/bf78d26ec3f4da976d9c694a660d40b718d86043/for-docs/2019-08-10-recent-replies-ex-anon-arw.jpg "Recent replies")

<!--
![Recent replies](/images/web/ty-media/for-docs/2019-08-10--recent-replies-ex-anon-arw.jpg?raw=true "Recent replies") -->

<br>

### Topic list:

<!--
![topic-list-borders](https://user-images.githubusercontent.com/7477359/44306130-a3930080-a388-11e8-9cbc-e569f5ddb7a1.jpg)
 the old demo forum looks better? so use instead.  -->

![ideas-topics](https://raw.githubusercontent.com/debiki/talkyard-media/bf78d26ec3f4da976d9c694a660d40b718d86043/for-docs/2019-08-10-idea-topics-list-ex.jpg "Topics list")
<!--
![ideas-topics](/images/web/ty-media/for-docs/2019-08-10-idea-topics-list-ex.jpg?raw=true "Topics list")

![ed-demo-forum-index](https://cloud.githubusercontent.com/assets/7477359/19650764/bb3a1450-9a0a-11e6-884d-d23c93476db3.jpg) -->

<br>

### Chat:

Notifications via email, as of now. Some time later, there'll be a PWA mobile app with push notifications.

<br>

<!--
Currently, Talkyard is a mobile friendly web app.
Within half a year or a year (today is August 2018),
the plan is that there'll be a white labelled mobile app.
Meaning, people will be able to install your community, on their mobile phones,
as a separate app with your custom icon.
Push notifications for Android
(however, initially not for iPhone — iPhone currently cannot do PWA mobile app push notifications).
-->

![chat-topic](https://raw.githubusercontent.com/debiki/talkyard-media/bf78d26ec3f4da976d9c694a660d40b718d86043/for-docs/2017-09-12-chat-ex.jpeg "A chat channel")

<!--
![chat-topic](/images/web/ty-media/for-docs/2017-09-12-chat-ex.jpeg?raw=true "A chat channel")
-->

<!--
![ed-e2e-chat-owen-maria](https://cloud.githubusercontent.com/assets/7477359/19674424/608c49aa-9a88-11e6-8ccd-c2e7ceebd0c2.jpg)
-->

<br>
<!--
![Q&A about how to wake up on time](https://user-images.githubusercontent.com/7477359/39368115-0549fad0-4a39-11e8-9bba-703d595d2b96.jpg)
-->
<!--
Hacker News / Reddit style discussion:
![ed-discussion-semantics-of-upvote-2013](https://cloud.githubusercontent.com/assets/7477359/19650769/bea906aa-9a0a-11e6-8ea2-9ad771981f46.jpg)
-->

<!--
**Admin-getting-started guide:**

![ed-admin-intro-guide](https://cloud.githubusercontent.com/assets/7477359/19679591/99a12098-9aa2-11e6-8b65-705c2548cbea.jpg)
<br>

### Users online:

![ed-online-users](https://cloud.githubusercontent.com/assets/7477359/19680424/f0353f86-9aa5-11e6-84d9-94d46f228b93.jpg)

<br>
-->

### Blog comments:

Like Disqus — but lightweight, no ads, no tracking. Configure in the Admin Area, the Settings tab, the Embedded Comments sub tab. — Read more about blog comments, and an optional hosting service, here: https://www.talkyard.io/blog-comments

There's a Disqus importer — talk with us [in the forum](https://www.talkyard.io/forum/) if you want to migrate from Disqus to Talkyard.

<br>

![blog comments](https://raw.githubusercontent.com/debiki/talkyard-media/bf78d26ec3f4da976d9c694a660d40b718d86043/for-docs/2019-02-21-blog-comments-ex-anon.jpg "Blog comments")
<!--
![blog comments](/images/web/ty-media/for-docs/2019-02-21-blog-comments-ex-anon.jpg?raw=true "Blog comments")
-->
<br>

### Embarrassing questions, creative ideas:

Planned, not yet implemented: Let your students ask anonymous questions. Maybe they feel ashamed for not knowing? — Or let your co-workers submit ideas and feedback, anonymously. Maybe they feel worried their ideas has crossed the border from Creative to Crazy? They can un-anonymize themselves later if they want to. (Anonymous posting first needs to be enabled, by admins. Here you can read more: https://www.talkyard.io/-239/is-there-anonymous-messages-support-for-the-full-talkyard )

<br>

![Post anonymously](https://raw.githubusercontent.com/debiki/talkyard-media/bf78d26ec3f4da976d9c694a660d40b718d86043/for-docs/2019-08-10-editor-post-anonymously-ex-arw.jpg "Post anonymously")

<hr>
<br>



Contributing
-----------------------------

Say hello in the community: <https://www.talkyard.io/forum/>.
<!--
Good for you if you ask the people there what is currently being worked on, so you won't
accidentally re-implement something that's almost done already — people
might be working in their own work-in-progress topic branches that you
don't know about. -->

How to translate to a new language: [i18n-README](translations/i18n-README.md) (step 1 and 2 only). — Open any translations pull request to the ty-translations repo: https://github.com/debiki/ty-translations.

You need to agree to [this Contributor License Agreement](./docs/CLA-v2.txt). You do that by
reading it (there's a human friendly intro) and appending a single line
paragraph with your real name (no pseudonyms) and the following text,
to all your Git commit messages: (note: a _Git commit message_ is not the same thing as a _GitHub comment_)

> I, Your Full Name \<your@<i></i>email.address\>, agree to the Contributor License Agreement, docs/CLA-v2.txt.

Please squash your commits to just one (unless you're doing something that's easier
to review in separate commits).




Getting Started
-----------------------------

This repo is for **development**. To install and *use* the software, instead go here:
[talkyard-prod-one](https://github.com/debiki/talkyard-prod-one)


#### Before you start

As operating system, you can use Debian 10, probably Debian 11, Ubuntu 20.04 should work too.
We use Debian 9 and 10, soon Debian 11.

You need about 6 GB RAM for the development environment (whereas the production environment needs about 2 GB).
And an internet connection — you'll download perhaps 1 GB Docker images and other files.

Install Docker and Docker-Compose, see: https://docs.docker.com/compose/install/.
On Linux, you can:

```
sudo -i
curl -fsSL https://get.docker.com -o install-docker.sh
sh install-docker.sh
curl -L "https://github.com/docker/compose/releases/download/1.28.5/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
docker-compose --version  # should print "docker-compose version ... build ..."
```

Read [A brief intro to Docker-Compose](docs/intro-to-docker-compose.md) — unless you know
how to use docker-compose already.


#### The instructions


1. Append some settings to the system config, so ElasticSearch will work.
   ElasticSearch will get downloaded later, in a Docker image (don't install it yourself).
   — Run this as one single command, not one line at a time:

       sudo tee -a /etc/sysctl.conf <<EOF

       ###################################################################
       # Talkyard settings

       # Up the max backlog queue size (num connections per port), default = 128
       net.core.somaxconn=8192

       # ElasticSearch requires (at least) this, default = 65530
       # Docs: https://www.kernel.org/doc/Documentation/sysctl/vm.txt
       vm.max_map_count=262144

       # VSCode and IntelliJ Idea want to watch many files — without this, there'll be
       # a "Unable to watch for file changes in this large workspace" error in VSCode.
       # Also an "User limit of inotify watches reached" error can happen, when
       # tailing logs, if too few watches. (The default is sometimes only 8192.)
       fs.inotify.max_user_watches=524288
       EOF

    Reload the system config:

       sudo sysctl --system

1. You need Git, Make, cURL, `jq` for viewing logs, `gpg2` for checking signatures,
    and a file change notifier:

    ```
    sudo apt install git make curl jq gpg2 inotify-tools
    ```

1. (Optional step, for now.)
    Install Nix-shell, see https://nixos.org/download.html#nix-verify-installation.
    Nix gives you all build tools, no need to modify your host OS.
    For example, Nodejs 14. And later, Deno, and Rust build stuff.

    Get the installation script and signature:

    ```
    curl -o install-nix-2.3.15     https://releases.nixos.org/nix/nix-2.3.15/install
    curl -o install-nix-2.3.15.asc https://releases.nixos.org/nix/nix-2.3.15/install.asc
    ```

    Import the public signing key:
    ```
    # Try this:
    gpg2 --recv-keys B541D55301270E0BCF15CA5D8170B4726D7198DE

    # Or, if that won't work, the key is in the vendors/ dir:
    gpg2 vendors/nixos-signing-pub-key.gpg
    # should print:  B541D55301270E0BCF15CA5D8170B4726D7198DE
    # then:
    gpg2 --import vendors/nixos-signing-pub-key.gpg
    ```

    Verify the signature — this should say "Good signature", and print:
    `Primary key fingerprint: B541 D553 0127 0E0B CF15  CA5D 8170 B472 6D71 98DE`:

    ```
    gpg2 --verify ./install-nix-2.3.15.asc
    ```

    Install Nix and, optionally, Niv.
    Either **1/2:** First create the `/nix` directory for yourself,
    and then install — no need to be root:
    (see https://nixos.wiki/wiki/Nix_Installation_Guide)

    ```
    sudo install --directory --mode=755 --owner=$(id -u) --group=$(id -g) /nix
    sh ./install-nix-2.3.15    # not root
    # nix-env -iA nixpkgs.niv  # optionally, if you want to upgrade Ty's build tools
    ```

    (To uninstall Nix, remove `/nix`, a line in `~/.profile`, and:
    `~/{.nix-channels,.nix-defexpr,.nix-profile,.config/nixpkgs}`)

    Or alternatively, **2/2:** Do a multi-user installation of Nix:
    https://nixos.org/manual/nix/stable/#sect-multi-user-installation
    (then I'd think it's best to use the above `./install-nix-...`
    script whose signature you've verified).


1. Clone the Talkyard repository:

    ```
    git clone https://github.com/debiki/talkyard.git talkyard
    cd talkyard
    ```

1. Download dependencies — they're in Git submodules:
    (this might take long — you'll be downloading about 1 GB files)

    ```
    git submodule update --init
    ```

1. Start Talkyard: (`s/tyd` is a Talkyard development helper script)

    ```
    s/tyd up
    ```

    And have a coffee — it takes a while before Talkyard starts the first time:
    Typescript, Stylus and Scala code gets compiled and packaged, Docker images get built.
    To view log messages, type `s/tyd logs -f` (or `docker-compose logs -f`).

    Wait for these "Server started" log messages to appear:

        app_1  |
        app_1  | --- (Running the application, auto-reloading is enabled) ---
        app_1  |
        app_1  | [info] p.c.s.NettyServer - Listening for HTTP on /0:0:0:0:0:0:0:0:9000
        app_1  | [info] p.c.s.NettyServer - Listening for HTTPS on /0:0:0:0:0:0:0:0:9443
        app_1  |
        app_1  | (Server started, use Ctrl+D to stop and go back to the console...)
        app_1  |


1. Point your browser to http://localhost/. This sends a request to the Docker container
   named 'web', in which Nginx listens on port 80. Nginx sends the request to Play Framework
   in the 'app' container, port 9000. Play Framework then starts compiling more Scala files — this
   take a little while; the browser might show a 502 Bad Gateway error message.

   Soon, when done compiling, Play Framework will start. Then this gets logged:

       app_1  | [info] application - Starting... [TyMHELLO]
       ...
       ...
       app_1  | [info] application - Started. [TyMSTARTED]

   If you don't see these messages (maybe they scroll past too fast), you can
   continue with the next step just below anyway — just keep reloading the browser page until
   any "is starting" message in the browser window disappears.


1. Create a forum

   Reload the browser at http://localhost/. A page with a button should appear.
   Sign up as admin with this email: `admin@example.com` (must be that email).
   As username and password you can type `admin` and `public1234`.

<!-- Not needed any longer.
   You'll be asked to confirm your email address, by clicking a link in an email
   that was sent to you — but in fact the email couldn't be sent, because you haven't configured
   any email server, and `admin@example.com` isn't your address anyway.

   Instead look at the log messages. (Run `sudo docker-compose logs app` if you've closed
   the terminal with log messages.) There you'll find
   the email — it's written to the log files, in development mode. Copy the
   confirmation link from the `<a href=...>` and paste it in the browser's address bar.
   -->

Shut down everything like so: `s/tyd kill`. (To remove all containers: `s/tyd down`.)



Editing source code
-----------------------------

### Typescript

To edit Typescript code (in `client/app-*/`) you can use VSCode.

To automatically recompile code you've edited, so the changes appear in your
browser after reload, do this:

```
s/tyd tw   # 'tw' means "transpile" and "watch"
```

But wait five seconds, after you've edited any Typescript code, before you reload the page in
the browser — otherwise the Typescript code might not yet have been transpiled.
(Details: There's a Docker container with Node.js installed, which recompile Typescript and Stylus CSS.)

### Scala

To edit Scala code (in `app/*`), you can use IntelliJ IDEA, the free community edition.
Don't forget to install a Java Development Kit (JDK) — in Debian 9:

    sudo apt install default-jdk  # installs JDK 8

There's a container, named *app*, which runs the Play Framework application server,
and looks for changes to Scala files, recompiles and reloads.

Unfortunately, if you keep editing and reloading Scala files many many times, then eventually
Play Framework runs out of memory. Restart it like so: `s/tyd ra` ('ra' means "restart app").



Building your own images
-----------------------------

Do this: (`make` is GNU Make)

```
vi version.txt    # type a new vesion number
vi .env           # change DOCKER_REPOSITORY to your own repository
make prod-images  # this runs tests and builds production images
make tag-and-push-latest-images tag=...  # pushes images to your repo
```

You can type `make` to see help about the Makefile targets.

All this has been tested in Ubuntu and Mint Linux only, with Bash. If you're
on Windows, probably you'll need [Cygwin](https://www.cygwin.com)
or [MinGW](http://www.mingw.org).

To use the images in your own Docker-Compose installation,
have a look here: https://github.com/debiki/talkyard-prod-swarm



About the images
-----------------------------

Here you can read about the various images in the Talkyard stack:
[about-the-talkyard-images.md](./docs/about-the-talkyard-images.md).



Troubleshooting
-----------------------------

See [tips.md](./docs/tips.md).



Tests
-----------------------------

#### End-to-end tests

The end-to-end tests are written in TypeScript and uses Selenium and Webdriver.io.
See the [end-to-end tests readme](./docs/e2e-tests-readme.md).
And, you also need to [make *.localhost addresses work](./docs/wildcard-dot-localhost.md),
because the e2e tests creates test sites at `*.localhost` sub domains.


#### Security tests

The security tests are written in TypeScript and use Tape = test-anything-protocol for Node.js.
See the [security tests readme](./docs/security-tests-readme.md).


#### Unit tests

Stop everything: `sudo docker-compose down` and then: `s/cli` then type `test` + hit Enter.


#### Performance tests

Install Scala SBT, see http://www.scala-sbt.org/download.html. On Linux:

```
echo "deb https://dl.bintray.com/sbt/debian /" | sudo tee -a /etc/apt/sources.list.d/sbt.list
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 2EE0EA64E40A89B84B2DF73499E82A75642AC823
sudo apt-get update
sudo apt-get install sbt
```

Append to `/etc/security/limits.conf` ... hmm but now with Docker-Compose, which container?

    your_login_name hard nofile 65535
    your_login_name soft nofile 65535

Configure very high max-requests-per-ip-per-second etc Nginx limits — otherwise during the performance
test Nginx will start to rate limit stuff and reply 503 Service Not Available:

```
sudo docker-compose  -f docker-compose.yml  -f docker-compose-no-limits.yml  up -d
```


Technology
-----------------------------

- Client: React.js, TypeScript, Webdriver.io.
- Server: Scala and Play Framework. OpenResty, some Lua. React.js in Java's Nashorn Javascript engine.
- Databases: PostgreSQL, Redis, ElasticSearch.



Directories
-----------------------------

This project looks like so:


    server/
     |
     +-Makefile             <-- You can build Talkyard, using GNU Make
     |                          (work in progress, as of Nov 2018)
     |
     +-docker-compose.yml   <-- Tells Docker how to run Talkyard
     |
     +-client/         <-- Javascript, CSS, React.js components
     | +-app/          <-- Client side code
     | +-server/       <-- React.js components rendered server side,
     | :                   usually softlinks to ../app/
     | :
     |
     +-app/            <-- Scala code — a Play Framework 2 application
     |
     +-tests/
     | +-app/          <-- Unit tests and functional tests, for the app server
     | +-e2e/          <-- End-to-end tests
     | +-security/     <-- Security tests
     |
     +-modules/
     | +-ty-dao-rdb/        <-- A database access object (DAO), for PostgreSQL
     | +-ed-core/           <-- Code shared by the DAO and by the ./app/ code
     | +-ed-prod-one-test/  <-- A production installation, for automatic tests
     | |
     | ...Third party modules
     |
     +-to-talkyard/    <-- For converting e.g. phpBB or Disqus export files
     |                     to Talkyard's JSON format, so they can be imported
     |                     into Talkyard. This is a stand-alone Node.js app.
     |
     +-images/
     | +-web/          <-- For building the 'web' Docker image, runs Nginx
     | | +-Dockerfile
     | | +-assets/     <-- Typescript and Stylus compiled to JS and CSS
     | | +-modules/    <-- Nginx (OpenResty) and Lua modules
     | | +-openresty/  <-- OpenResty source code (we build from soruce)
     | | ...
     | |
     | +-gulp/         <-- An image that runs Node.js and bundles JS and CSS
     | |
     | +-...           <-- More images, see: docs/about-the-talkyard-images.md
     |
     +-volumes/
     | +-rdb-data      <-- Mounted as a volume in the Postgres container
     | +-gulp-home/    <-- Gulp container home-dir = disk cache
     | +-uploads       <-- Mounted read-write in the Play container, but
     | |                 read-only in Nginx (to serve static files)
     | ...
     |
     +-d/         <-- Docker scripts, e.g. d/c is docker-compose, and
     |                'd/n a-script' runs a-script in a Nodejs Docker container
     |                ('docker-compose' is soo loong to type).
     |                Many scripts still in s/* instead, could move to here?
     |
     +-s/         <-- Utility Bash scripts (typing "scripts/" is so long),
     |                e.g. s/run-e2e-tests.sh, or, to run in a container:
     |                'd/n s/run-e2e-tests.sh'  — combining the d/* and s/*
     |                scripts.
     |
     +-conf/      <-- App server (Play Framework) config files
     | +-my.conf  <-- You can add your localhost config here. Ignored by Git.



Naming style, tags and a new word
-----------------------------

### CSS classes and ids

*Example*: `s_P_By_FN-Gst`. Here, `s_` is a prefix used for all classes, and
it means "some". For ids we use `t_` instead, means "the". `P` means Post. `By` means
who-was-it-written-By. `FN` means Full Name. `Gst` means Guest.

So, this is BEM (Block Element Modifier) with a few tweaks: Blocks/elements are separated with
only one underscore, and modifiers with only one dash. Blocks, elems and modifiers always
start with uppercase — because then it's easy to tell if we're dealing with an _abbreviation_
or not. For example, `FN` (full name) is an abbreviation. But `By` is not (since it continues with
lowercase letters).

Another example: `s_Dfs_Df_Ttl` — this means the title (Ttl), of a draft (Df),
in a list of drafts (Dfs).  You'll find abbreviations like Ttl and Df, in
[bem-blocks.txt](./docs/bem-blocks.txt).

<!-- I think these short names actually improve readability, once you know what they means.
Seeing `s_Dfs_Df_Ttl` in the source code — that's brief and quick to read, doesn't steal
the attention from other things nearby you're probably more inteested in.
(too chatty, skip this)  -->

For stuff with otherwise no class or id, and that should be clicked in end-to-end tests,
we use classes only, and the prefix `e_` (instead of `s_` or `t_`).


### Single and double quotes

In Typescript (and any Javascript), use single quotes for strings the computer cares about,
like CSS classes or ids, e.g. `className: 's_P'` or `reactRenderMethod = 'hydrate'`,
or React component display names.
For texts that humans read, instead use double quotes, like: `Button({ ...}, "Undo")`.
When doing this, you can be fairly certain that if you edit a single quote string,
without knowing what you're doing, something will break.
Whilst if you edit a double quoted string and fix e.g. a spelling errors: the computer
won't care, but humans like it.


### Tag the code

Some parts of a software system, knows how other parts of the software system works,
sometimes in not-obvious ways. Make such otherwise hidden duplicated knowledge visible,
by tagging the code with tags like: `[1ABCDE2]`.
Example: `// Also done here: [4JKAM7] when deleting pages.`.
Or there's a 3rd partly lib bug workaround in one source code file, for a problem that happens
in a different file, and an end-to-end test that got affected, example: `[5QKBRQ]`.
Tag those three places with the same tag.
Just type a number, random uppercase letters, and another number, to create a tag.
And copy-paste it to where the related code is.


### Message codes and magic underscores

Log messages, and plain text messages sent back to the browser, start with `TyM` if it's
an info message, and `TyE` if it's an error. Like, `"Started. [TyMSTARTED]"` (a log message).

These messsage codes helps you instantly find the relevat source code, if there's
an error message anywhere. Otherwise, it can be terribly annoying,
when the browser says "Not found", and you have no idea where that message comes from.
For example, Nginx didn't find a location handler? Or a user is missing? Or a page? Or a post?
Or a client side route is missing? Or the hostname is wrong? Or ...?
And you search for "Not found" and find 1 000 matches.
Now, instead, you'll see `"Not found [TyE123ABC]"` — and you then search for "TyE123ABC"
and find the relevant source code.

Some message codes sent to the browser are checked for in end to end tests. They shall
have an underscore `_` at the *end* (because it's called *end* to *end* tests). So, if you see a
message code like: `"TyM0APPR_"` and you change it, you need to search for it
everywhere and update some end-to-end tests too.

Some message codes are checked for by production code Typescript, i.e. *front*end code.
They shall have a `_` at the beginnign (front) of the error code, and here's how they can be used
server side: `throwForbidden("_TyE403BPWD", "Bad username or password")` and
client side: `if (xhr.responseText.indexOf('_TyE403BPWD') ...`. — So, when you're looking at the
server side code the `_` tells you that the error code is used in the frontend Typescript code,
so you cannot just change it.


### Database tables, constraints, index names

Add "as many constraints and foreign keys as you can". Knowing precisely what's in the
database, makes data migrations safer & simpler. Don't forget to index
foreign key columns. Type `ix: index-name` next to the foreign key constraints,
so one directly sees that there's an index, and its name. All fk constraints should
be deferrable.

**Table names:** `some_table3`. The trailing digit "3" is for historical reasons —
maybe change to "_t" instead? *Some* suffix is needed, so one can search
for `table_name3` e.g. `pages3` and find only the *table*, instead of 999 999
other unrelated "table_name" e.g. "pages" search hits.

**Unique indexes:** `tablename_u_columnone_coltwo_three...`

**Non-unique indexes:** `tablename_i_colone_coltwo_three...`

**Foreign keys:** `tablename_colone_coltwo_..._r_othertable(_col_coltwo_...)`

**Check constraints:** `tablename_c_...sth-to-check...` e.g. `pages_c_id_len` (length).

It's nice to have these one letter object types: `_u`, `_i`, `_c` because then they're
more full text searchable — e.g. find all usages of any (unique) indexes on a certain
table, accross the whole code base. And you soon learn to recognize what they mean so you know
what type of thing it is, without having to think or find out. Having them directly
after the table name (without the '3' suffix) makes things nicely aligned & easy to scan,
when typing `\d some_table_name` in the psql client.

Maybe it'd be nice if all column names ended with "_c"? E.g. `username_c`.
Because currently they're a bit hard to search for. Instead one needs to search
for the table name, and then look for the column name, in the surrounding code.

Most db things don't follow these naming standards, because I (KajMagnus) had different
ideas in the past. Maybe one day, time to rename everything to the correct names?


### Hen and henbirds

Source code comments should be concise, but writing "he or she" everywhere, when referring
to e.g. a user, becomes a bit verbose (because "he or she" is three words). There's
a short Swedish word that means "he or she", namely "hen". Let's start using it in English.

So: "hen" = either "he or she", or "him or her", depending on context.
And "hens" = "his or her", and "hen's" = "he or she is".

To refer to many hen = many-he-or-she, write "people". "Hens" however
means "his or her", just like "its" means, well, "its" (but not "things").

What about the bird previously called "hen"? Let's call it "henbird" instead.

So, hereafter, the word "hen" means "he or she". And the henbird, which I cannot
remember having mentioned or even thought about the past year, no longer gets
to occupy the short and useful word "hen".



Custom third party builds
-----------------------------

We're building & using a smaller version of Lodash, like so:
(this makes slim-bundle.min.js.gz 8kb = 4% smaller, as of September 2016)

    # COULD create custom typedef for this custom Lodash, so won't accidentally use
    # Lodash fns that have been excluded here?

    node_modules/lodash-cli/bin/lodash \
      include="assign,assignIn,before,bind,chain,clone,cloneDeep,compact,concat,create,debounce,defaults,defer,delay,each,escape,every,filter,find,findLast,flatten,flattenDeep,forEach,forOwn,groupBy,has,head,includes,identity,indexOf,isArguments,isArray,isBoolean,isDate,isEmpty,isEqual,isFinite,isFunction,isNaN,isNull,isNumber,isObject,isRegExp,isString,isUndefined,iteratee,keys,last,map,mapValues,matches,max,min,mixin,negate,noConflict,noop,once,partition,pick,reduce,remove,result,size,slice,some,sortBy,sumBy,take,tap,throttle,thru,toArray,uniq,uniqBy,uniqueId,value,values" \
      --output client/third-party/lodash-custom.js

    # If you upgrade Lodash, afterwards, have a look at the diff of `lodash-custom.js`
    # and scroll down towards the bottom. Look at the line `lodash.cloneDeep =` and below:
    # did any function unexpectedly disappear? If so, include it in the long list above
    # and regenerate `lodash-custom.js`.

- For security reasons, we checkin only the resulting `.js` file (but not the `.min.js`) file
into source control (so that you can read the source code and see what it does).
- There are some Gulp plugins that builds Lodash but one seems abandonend (gulp-lodash-builder)
and the other (gulp-lodash-custom) analyzes all .js files, I guess that'd slow down the build
rather much + won't immediately work with Typescript?



Old Code
-----------------------------

Old code from before January 2015 is available here:
https://github.com/debiki/debiki-server-old.
That repo, squashed, is in this repo.



License
-----------------------------

Copyright (c) 2010-2021 Kaj Magnus Lindberg and contributors.

Talkyard is multi licensed under 1) AGPLv3 or later, see LICENSE.txt, and
2) Business Source License v1.1, with change license GPLv2 or later, and
change date 2026-01-01 (we bump the change date yearly,
so it's between 4 and 5 years into the future) — see LICENSE-BUSLv1.1.txt.
And 3) possibly other licenses.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
above-mentioned licence texts for more details.


vim: list et ts=2 sw=2 tw=0 fo=r
